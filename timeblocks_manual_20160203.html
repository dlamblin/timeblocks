<!DOCTYPE html>
<head>
	<style type="text/css">
	body {
		font: 10pt sans-serif;
	}
    #timeblock {
        width: 100%;
        height: 420px;
    }
	#timeblock rect {
		fill: lightblue;
        stroke: lightgray;
        stroke-width: 2px;
	}
    #timeblock text {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 11px;
        fill: darkslategrey;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 11px;
    }
	</style>
<script src="d3/d3.min.js" not_src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script charset="utf-8">
	console.log("script");
	var timeFmt = d3.time.format.utc('%H.%M');
	function hm (i) {
        var s = i.toFixed(2);
        return timeFmt.parse((s.length < 4) ? '0' + s : s);
    }
	var timeData = [
        { key: "m1", "wday": 0, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" },
        { key: "m2", "wday": 0, "begin": hm( 7.00), "end": hm( 7.30), label: "Prep Sophie" },
        { key: "m3", "wday": 0, "begin": hm( 7.30), "end": hm( 8.00), label: "Transit to School" },
        { key: "t1", "wday": 1, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" },
        { key: "w1", "wday": 2, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" },
        { key: "r1", "wday": 3, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" },
        { key: "f1", "wday": 4, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" }
	];
    var timeDataMap = d3.map(timeData, function(d) {return d.key;});
    timeDataMap.forEach(function(k,v) {v.end.setMinutes(v.end.getMinutes()-5);});
    timeData = timeDataMap.values();
    var scale;

    function d3UpdateScales() {
        var svg = d3.select('#timeblock')[0][0],
            margin = {top: 20, right: 20, bottom: 20, left: 80},
            width = svg.clientWidth,
            height = svg.clientHeight,
            weekdayDomain = [0,1,2,3,4,5,6];
        return scale = {
            margin: margin,
            width:  width - margin.left - margin.right,
            height: height - margin.top - margin.bottom,
            time:   d3.time.scale.utc() // not d3.scale.linear()
                    .domain([d3.min(timeData, function(d) {return d.begin}),
                        d3.max(timeData, function(d) {return d.end})])
                    .rangeRound([0, width]),
            days:   d3.scale.ordinal()
                    .domain(weekdayDomain)
                    .range('Mon Tue Wed Thu Fri Sat Sun'.split(' ')),
            week:   d3.scale.ordinal()
                    .domain(weekdayDomain)
                    .rangeRoundBands([0, height], 0.05),
        }	    	
    }

	function d3Update() {
		console.log("d3Update");
        var scale = d3UpdateScales(),
            xaxistop = d3.svg.axis().scale(scale.time).tickSize(10).orient('top'),
            xaxisbot = d3.svg.axis().scale(scale.time).tickSize(10),
            yaxis = d3.svg.axis().scale(scale.days).tickSize(10).orient('right');

		// Update…
        var svg = d3.select('#timeblock');
		var g = svg.selectAll("g")
			.data(timeData);
		
		// Enter…
		var ge = g.enter()
			.append("g")

        ge.append("rect")
            .attr("x", function(d) {return scale.time(d.begin)})
            .attr("y", function(d) {return scale.week(d.wday)})
			.attr("width", function(d) {return (scale.time(d.end) - scale.time(d.begin))})
			.attr("height",  function(d) {return scale.week.rangeBand()});
		ge.append("text")
            .attr("x", function(d) {return scale.time(d.begin)})
            .attr("y", function(d) {return scale.week(d.wday) + scale.week.rangeBand() / 2})
            .attr("dy", ".35em")
			.text(function(d) { return d.label; });
		
		// Exit…
		g.exit().remove();
        
        svg.append("g").attr('class', 'axis').attr('transform', 'translate(0 -50)').call(xaxistop);
        svg.append("g").attr('class', 'axis').attr('transform', 'translate(0 300)').call(xaxisbot);
        svg.append("g").attr('class', 'axis').call(yaxis);
	}
	
	window.onload = d3Update;
</script>
</head>
<body>
	<h1>A week of blocked time</h1>
	<svg id="timeblock">
    </svg>
</body>