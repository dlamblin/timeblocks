<!DOCTYPE html>
<head>
	<style type="text/css">
	body, html {
		font: 10pt sans-serif;
        height: 100%;
	}
    section {
        display: flex;
        flex-flow: column;
        height: 100%;
    }
    #timeblock {
        display: flex;
        flex-flow: nowrap;
        width: 100%;
        height: 90%;
    }
	#timeblock rect {
		fill: lightblue;
        stroke: lightgray;
        stroke-width: 2px;
	}
    #timeblock text {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 11px;
        fill: darkslategrey;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 11px;
    }
	</style>
<script src="d3/d3.min.js" not_src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script charset="utf-8">
	console.log("script");
	var timeFmt = d3.time.format.utc('%H.%M'),
        weekday = 'Mon Tue Wed Thu Fri Sat Sun'.split(' ');
	function hm (i) {
        var s = i.toFixed(2);
        return timeFmt.parse((s.length < 4) ? '0' + s : s);
    }
	var timeData = [
        { key: "m1", "wday": 0, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc\n\retc" },
        { key: "m2", "wday": 0, "begin": hm( 7.00), "end": hm( 7.30), label: "Prep Sophie" },
        { key: "m3", "wday": 0, "begin": hm( 7.30), "end": hm( 8.00), label: "Transit to School" },
        { key: "t1", "wday": 1, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" },
        { key: "t2", "wday": 1, "begin": hm(17.00), "end": hm(18.00), label: "call" },
        { key: "w1", "wday": 2, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" },
        { key: "r1", "wday": 3, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" },
        { key: "f1", "wday": 4, "begin": hm( 6.00), "end": hm( 7.00), label: "Rising, dress etc" }
	];
    timeData = timeData.sort(function(a,b) {
        var o = d3.ascending(a.wday, b.wday);
        return o===0 ? d3.ascending(a.begin, b.begin) : o;
    });
    var timeDataMap = d3.map(timeData, function(d) {return d.key;});
    timeDataMap.forEach(function(k,v) {v.end.setMinutes(v.end.getMinutes()-5);});
    timeData = timeDataMap.values();
    var scale;

    function d3UpdateScales() {
        var svg = d3.select('#timeblock')[0][0],
            margin = {top: 25, right: 80, bottom: 25, left: 80},
            width = svg.clientWidth - margin.left - margin.right,
            height = svg.clientHeight - margin.top - margin.bottom;
        return scale = {
            margin: margin,
            width:  width,
            height: height,
            time:   d3.time.scale.utc() // not d3.scale.linear()
                    .domain([d3.min(timeData, function(d) {return d.begin}),
                        d3.max(timeData, function(d) {return d.end})])
                    .rangeRound([0, height]),
            days:   d3.scale.ordinal()
                    .domain(weekday)
                    .rangePoints([0, width]),
            week:   d3.scale.ordinal()
                    .domain(weekday)
                    .rangeRoundBands([0, width], 0.05),
        }	    	
    }

	function d3Update() {
		console.log("d3Update");
        var scale = d3UpdateScales(),
            xaxis_t = d3.svg.axis().scale(scale.week).tickSize(13).orient('top'),
            yaxis_r = d3.svg.axis().scale(scale.time).tickSize(7).orient('right');
            xaxis_b = d3.svg.axis().scale(scale.week).tickSize(13),
            yaxis_l = d3.svg.axis().scale(scale.time).tickSize(7).orient('left');

		// Update…
        var svg = d3.select('#timeblock');
        if (svg.select('g.view')[0][0] == null) {
            svg.append('g').attr('class', 'view').attr('transform', 'translate(' + scale.margin.left + ',' + scale.margin.top + ')');
        }
		var g = svg.select('g.view').selectAll('g.data')
			.data(timeData);
		
		// Enter…
		var ge = g.enter()
			.append("g")
            .attr('class', 'data');

        ge.append("rect")
            .attr("x", function(d) {return scale.week(weekday[d.wday])})
            .attr("y", function(d) {return scale.time(d.begin)})
			.attr("width",  function(d) {return scale.week.rangeBand()})
			.attr("height", function(d) {return (scale.time(d.end) - scale.time(d.begin))});
		ge.append("text")
            .attr("x", function(d) {
                return scale.week(weekday[d.wday]) + 2})
            .attr("y", function(d) {return scale.time(d.begin)})
            .attr("dy", ".85em")
			.text(function(d) { return d.label; });
		
		// Exit…
		g.exit().remove();
        
        svg.append("g").attr('class', 'axis')
            .attr('transform', 'translate('
                + String(scale.margin.left) + ','
                + String(scale.margin.top) + ')')
            .call(xaxis_t);
        svg.append("g").attr('class', 'axis')
            .attr('transform', 'translate('
                + String(scale.margin.left) + ','
                + String(scale.height + scale.margin.top) + ')')
            .call(xaxis_b);
        svg.append("g").attr('class', 'axis')
            .attr('transform', 'translate('
                + String(scale.margin.left - 5) + ','
                + String(scale.margin.top) + ')')
            .call(yaxis_l);
        svg.append("g").attr('class', 'axis')
            .attr('transform', 'translate('
                + String(scale.margin.left + scale.width + 5) + ','
                + String(scale.margin.top) + ')')
            .call(yaxis_r);
	}
	
	window.onload = d3Update;
</script>
</head>
<body>
	<h1>A week of blocked time</h1>
	<section><svg id="timeblock">
    </svg></section>
</body>